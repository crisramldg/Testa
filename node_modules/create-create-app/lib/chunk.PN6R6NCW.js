"use strict";Object.defineProperty(exports, "__esModule", {value: true}); function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }var _chalk = require('chalk'); var _chalk2 = _interopRequireDefault(_chalk);var _crossspawn = require('cross-spawn');var _epicfail = require('epicfail'); var _epicfail2 = _interopRequireDefault(_epicfail);var _execa = require('execa'); var _execa2 = _interopRequireDefault(_execa);var _fs = require('fs'); var _fs2 = _interopRequireDefault(_fs);var _gitconfig = require('gitconfig'); var _gitconfig2 = _interopRequireDefault(_gitconfig);var _licensejs = require('license.js');var _path = require('path'); var _path2 = _interopRequireDefault(_path);var _yargsinteractive = require('yargs-interactive'); var _yargsinteractive2 = _interopRequireDefault(_yargsinteractive);var _globby = require('globby'); var _globby2 = _interopRequireDefault(_globby);var _handlebars = require('handlebars'); var _handlebars2 = _interopRequireDefault(_handlebars);var _isutf8 = require('is-utf8'); var _isutf82 = _interopRequireDefault(_isutf8);var _slash = require('slash'); var _slash2 = _interopRequireDefault(_slash);var _uuid = require('uuid');function A(e){return e.split(/[-_\s]+/)}function G(e){return A(m(e)).join(" ")}_handlebars2.default.registerHelper("space",G);function m(e){return e.replace(/[\r\n]/g,"")}_handlebars2.default.registerHelper("trim",m);function M(e){return m(e).toUpperCase()}_handlebars2.default.registerHelper("upper",M);function R(e,t){let i=t&&t.hash&&t.hash.space;return m(e).toLowerCase()}_handlebars2.default.registerHelper("lower",R);function C(e,t){let i=t&&t.hash&&t.hash.space;return A(m(e)).map(a=>a.charAt(0).toUpperCase()+a.slice(1).toLowerCase()).join(i?" ":"")}_handlebars2.default.registerHelper("capital",C);function W(e){return C(e).replace(/^./,t=>t.toLowerCase())}_handlebars2.default.registerHelper("camel",W);function N(e){return C(e).replace(/(?<=([a-z](?=[A-Z])|[A-Za-z](?=[0-9])))(?=[A-Z0-9])/g,"_").toLowerCase()}_handlebars2.default.registerHelper("snake",N);function q(e){return N(e).replace(/_/g,"-")}_handlebars2.default.registerHelper("kebab",q);function J(){return _uuid.v4.call(void 0, )}_handlebars2.default.registerHelper("uuid",J);function T(e,t){return _handlebars2.default.compile(e.toString(),{noEscape:!0})(t)}function K(e){try{let t=_path2.default.dirname(e);_fs2.default.mkdirSync(t,{recursive:!0})}catch(t){}}function $(e){return _fs2.default.readdirSync(e).filter(t=>!t.startsWith("."))}async function L(e){let t=await _globby2.default.call(void 0, _slash2.default.call(void 0, e.templateDir),{dot:!0});for(let i of t){let a=_path2.default.relative(e.templateDir,i),s=T(_path2.default.resolve(e.packageDir,a),e.view);K(s);let n=_fs2.default.readFileSync(i),o=n;_isutf82.default.call(void 0, n)&&(o=Buffer.from(T(n,e.view))),_fs2.default.writeFileSync(s,o,"utf-8")}}var f=class extends Error{constructor(t){super(t);this.name="CLIError"}};async function ie(){var e;try{return(e=(await _gitconfig2.default.get({location:"global"})).user)!=null?e:{}}catch(t){return{}}}function ne(e,t=[],i={}){return new Promise((a,s)=>{_crossspawn.spawn.call(void 0, e,t,{stdio:"inherit",...i}).on("close",o=>{if(o!==0)return s(o);a(o)})})}async function ae(e,t){let i,a;t?(i="yarnpkg",a=["install","--cwd",e]):(i="npm",a=["install"],process.chdir(e));try{await ne(i,a,{stdio:"inherit"})}catch(s){throw new f(`installDeps failed: ${s}`)}}async function se(){try{return await _execa2.default.call(void 0, "yarnpkg",["--version"]),!0}catch(e){return!1}}function oe(e,t){return _fs2.default.existsSync(_path2.default.resolve(t,e))}async function ce(e){await _execa2.default.call(void 0, "git init",{shell:!0,cwd:e})}function j(e,t){return`${e}${t?` <${t}>`:""}`}function le(e){try{return _fs2.default.readdirSync(e).filter(t=>!t.startsWith(".")).length!==0}catch(t){if(t.code==="ENOENT")return!1;throw t}}async function pe(e,t,i={}){let a=await ie(),s=$(e),o=s.length>1&&t;return{interactive:{default:!0},description:{type:"input",describe:"description",default:"description",prompt:"if-no-arg"},author:{type:"input",describe:"author name",default:a.name,prompt:"if-no-arg"},email:{type:"input",describe:"author email",default:a.email,prompt:"if-no-arg"},template:{type:"list",describe:"template",default:"default",prompt:o?"if-no-arg":"never",choices:s},license:{type:"list",describe:"license",choices:[..._licensejs.availableLicenses.call(void 0, ),"UNLICENSED"],prompt:"if-no-arg"},...i}}async function Ie(e,t){_epicfail2.default.call(void 0, {assertExpected:r=>r.name==="CLIError"});let i=process.argv[2];if(i===void 0)throw new f(`${e} <name>`);let a=i===".",s=a?_path2.default.basename(process.cwd()):t.modifyName?await Promise.resolve(t.modifyName(i)):i,n=a?process.cwd():_path2.default.resolve(s),{templateRoot:o,promptForTemplate:x=!1}=t;if(le(n))throw new f(`${n} is not empty directory.`);let U=await pe(o,x,t.extra),l=await _yargsinteractive2.default.call(void 0, ).usage("$0 <name> [args]").interactive(U),P=l.template,v=_path2.default.resolve(o,P),b=new Date().getFullYear(),D=j(l.author,l.email);if(!_fs2.default.existsSync(v))throw new f("No template found");let S=Object.entries(l).filter(r=>r[0].match(/^[^$_]/)&&!["interactive","template"].includes(r[0])).reduce((r,p)=>(r[p[0]]=p[1],r),{}),V={...S,name:s,year:b,contact:D};console.log(`
Creating a new package in ${_chalk2.default.green(n)}.
`),await L({packageDir:n,templateDir:v,view:V});try{let r=_licensejs.makeLicenseSync.call(void 0, l.license,{year:b,project:s,description:l.description,organization:j(l.author,l.email)}),p=r.header+r.text+r.warranty;_fs2.default.writeFileSync(_path2.default.resolve(n,"LICENSE"),p)}catch(r){}let H=await se();oe("package.json",n)&&(console.log("Installing dependencies."),await ae(n,H));try{await ce(n),console.log(`
Initialized a git repository`)}catch(r){if(r.exitCode==127)return;throw r}let E={name:s,packageDir:n,template:P,templateDir:v,year:b,run:(r,p={})=>{let u=r.split(" ");return _execa2.default.call(void 0, u[0],u.slice(1),{stdio:"inherit",cwd:n,...p})},installNpmPackage:r=>new Promise((p,u)=>{let d,h;H?(d="yarnpkg",h=["--cwd",n,"add",r]):(d="npm",h=["install","-D",r],process.chdir(n)),_crossspawn.spawn.call(void 0, d,h,{stdio:"inherit"}).on("close",_=>{if(_!==0)return u(`installDeps failed: ${d} ${h.join(" ")}`);p()})}),answers:{...S,contact:D}};if(t.after&&await Promise.resolve(t.after(E)),console.log(`
Success! Created ${_chalk2.default.bold.cyan(s)}.`),t.caveat)switch(typeof t.caveat){case"string":console.log(t.caveat);break;case"function":let r=await Promise.resolve(t.caveat(E));r&&console.log(r);break;default:}}exports.a = f; exports.b = Ie;
